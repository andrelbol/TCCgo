{% extends 'base.html' %}

{% block titleBlock %} TCC Go {% endblock %}

{% block content %}

<div class="container" ng-controller="loginController">
  <div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-6">
      <h3>Login</h3>
      <hr>
    </div>
    <div class="col-md-3"></div>
  </div>
  <div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-6">
      <form method="post" action="login" id="myForm" name="myForm" ng-submit="send($event)" validate>
        {% csrf_token %}
        <div class="form-group row">
          <label for="user" class="col-md-2 col-form-label">Usuário</label>
          <div class="col-md-10">
            <input type="email" class="form-control" id="email" name="email" ng-model="user.email" required placeholder="ana@email.com">
            <div style="color:red; font-size:150%" align="right" ng-if="type_error == 404" >
              <span>Email não encontrado</span>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label for="password" class="col-md-2 col-form-label">Senha</label>
          <div class="col-md-10">
            <input type="password" class="form-control" id="password" name="password" ng-model="user.password" required placeholder="********">
            <div style="color:red; font-size:150%" align="right" ng-if="type_error == 300" >
              <span>Senha Inválida</span>
              <div style="color:red; font-size:150%" align="right" ng-if="type_error == 1" >
                <span>Login Inválido</span>
              </div>
            </div>
          </div>
        </div>


        <div class="form-group row">
          <div class="text-right">
            <button type="submit" class="btn btn-primary">Entrar</button>
          </div>
        </div>
      </form>
    </div>
    <div class="col-md-3"></div>
  </div>
</div>

{% endblock %}

{% block script %}

<script type="text/javascript">
  var app = angular.module("myApp", []);
  app.controller("loginController", function($scope, $http){
    $http.defaults.xsrfCookieName = 'csrftoken';
    $http.defaults.xsrfHeaderName = 'X-CSRFToken';

    $scope.user={
      email: '',
      password: ''
    };
    $scope.invalid = false;
    $scope.type_error = 0;

    $scope.send = function (e) {
        e.preventDefault();
        console.log('helo');
        alert($scope.user.email + '  ' + $scope.user.password);
          $http.post('/auth/check_login', $scope.user).then(function(response){

            alert(response.data['falha']+'  ' + response.data['url']);
            if(response.data['success'])
            {
              window.location = response.data['url'];
            }
            else{
              $scope.invalid = true;
              if(response.data['falha'] == 300){ // senha invalida
                $scope.type_error = 300;
              }else if(response.data['falha'] == 404){ // email invalida
                $scope.type_error = 404;
              }
              else{
                $scope.type_error = 1;
              }
            }
          });
        }

});
  </script>
{% endblock %}
